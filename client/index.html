<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashnest</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" type="image/png" href="img/download.jpg" />
  </head>
  <body>
    <nav id="main-nav" style="display: none">
      <div class="nav-features">
        <button class="btn btn-secondary" onclick="showSection('networth')">
          üí∞ Net Worth
        </button>
        <button class="btn btn-secondary" onclick="showSection('expenses')">
          üìä Expenses
        </button>
      </div>
      <div class="nav-user">
        <span id="nav-username"></span>
        <button id="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
          üåô
        </button>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
      </div>
    </nav>

    <main>
      <!-- Authentication Section -->
      <section id="auth-section">
        <div class="auth-card fade-in">
          <h1 class="text-center">Welcome to Cashnest</h1>
          <p
            class="text-center"
            style="color: var(--gray-600); margin-bottom: var(--space-xl)"
          >
            Your modern personal finance companion
          </p>

          <div class="auth-tabs">
            <button
              class="auth-tab active"
              onclick="switchAuthTab('login')"
              id="login-tab"
            >
              Login
            </button>
            <button
              class="auth-tab"
              onclick="switchAuthTab('register')"
              id="register-tab"
            >
              Register
            </button>
          </div>

          <form id="login-form" class="form-grid">
            <div class="form-group">
              <label for="login-username">Username</label>
              <input
                type="text"
                id="login-username"
                placeholder="Enter your username"
                required
              />
            </div>
            <div class="form-group">
              <label for="login-password">Password</label>
              <input
                type="password"
                id="login-password"
                placeholder="Enter your password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">Sign In</button>
          </form>

          <form id="register-form" class="form-grid" style="display: none">
            <div class="form-group">
              <label for="register-username">Username</label>
              <input
                type="text"
                id="register-username"
                placeholder="Choose a username"
                required
              />
            </div>
            <div class="form-group">
              <label for="register-password">Password</label>
              <input
                type="password"
                id="register-password"
                placeholder="Create a password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">
              Create Account
            </button>
          </form>

          <div id="auth-message"></div>
        </div>
      </section>

      <!-- Net Worth Section -->
      <section id="networth-section" style="display: none">
        <div class="fade-in">
          <h1>üí∞ Net Worth Dashboard</h1>
          <div id="networth-stats"></div>
          <nav id="networth-navbar" class="networth-navbar" style="margin-bottom: 2rem;">
            <button class="networth-tab active" onclick="switchNetworthTab('assets')" id="assets-tab">Assets</button>
            <button class="networth-tab" onclick="switchNetworthTab('debts')" id="debts-tab">Debts</button>
            <button class="networth-tab" onclick="switchNetworthTab('stocks')" id="stocks-tab">Stocks</button>
          </nav>
          <div id="networth-forms"></div>
          <div id="networth-lists"></div>
        </div>
      </section>
      // Net Worth tab switching logic
      function switchNetworthTab(tab) {
        document.getElementById("assets-tab").classList.remove("active");
        document.getElementById("debts-tab").classList.remove("active");
        document.getElementById("stocks-tab").classList.remove("active");
        document.getElementById(tab + "-tab").classList.add("active");
        localStorage.setItem("networthTab", tab);
        if (typeof renderNetWorthForms === "function") renderNetWorthForms(tab);
        if (typeof renderNetWorthLists === "function") renderNetWorthLists(tab);
      }

      window.addEventListener("DOMContentLoaded", function () {
        const tab = localStorage.getItem("networthTab") || "assets";
        switchNetworthTab(tab);
      });

      <!-- Expenses Section -->
      <section id="expenses-section" style="display: none">
        <div class="fade-in">
          <h1>üìä Expense Tracker</h1>
          <div class="card">
            <div class="card-header">
              <h3>Add New Expense</h3>
            </div>
            <div class="card-content">
              <form id="add-expense-form" class="form-grid">
                <div class="form-group">
                  <label for="expense-date">Date</label>
                  <input type="date" id="expense-date" required />
                </div>
                <div class="form-group">
                  <label for="expense-amount">Amount</label>
                  <input
                    type="number"
                    id="expense-amount"
                    placeholder="0.00"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="expense-details">Description</label>
                  <input
                    type="text"
                    id="expense-details"
                    placeholder="What was this expense for?"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="expense-category">Category</label>
                  <select id="expense-category" required>
                    <option value="">Select Category</option>
                    <option value="Grocery">üõí Grocery</option>
                    <option value="Bills">üì± Bills</option>
                    <option value="Entertainment">üé¨ Entertainment</option>
                    <option value="Financed Items">üí≥ Financed Items</option>
                    <option value="Investments">üìà Investments</option>
                    <option value="Food">üçî Food</option>
                    <option value="Transportation">üöó Transportation</option>
                    <option value="Hospital/Emergency">
                      üè• Hospital/Emergency
                    </option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">
                  Add Expense
                </button>
              </form>
            </div>
          </div>
          <div id="expenses-root"></div>
        </div>
      </section>
    </main>
    <script src="config.js"></script>
    <script src="networth/networth.js"></script>
    <script src="expenses/expenses.js"></script>
    <script>
      function showSection(section) {
        document.getElementById("networth-section").style.display = "none";
        document.getElementById("expenses-section").style.display = "none";
        document.getElementById("auth-section").style.display = "none";
        localStorage.setItem("lastSection", section);

        if (section === "networth") {
          document.getElementById("networth-section").style.display = "block";
        } else if (section === "expenses") {
          document.getElementById("expenses-section").style.display = "block";
        } else {
          document.getElementById("auth-section").style.display = "block";
        }

        // Ensure theme persists when switching sections
        setTimeout(() => {
          initializeTheme();
        }, 50);
      }

      window.onload = function () {
        // Initialize theme first
        initializeTheme();

        const token = localStorage.getItem("token");
        const loginTime = localStorage.getItem("loginTime");
        const now = Date.now();
        // If logged in and loginTime is set, check if 1 hour has passed
        if (token && loginTime && now - parseInt(loginTime, 10) > 3600000) {
          logout();
          return;
        }

        if (token) {
          // Try to get username from token or localStorage
          let username = localStorage.getItem("username");
          if (!username) {
            // If no stored username, try to decode from token (basic approach)
            try {
              const payload = JSON.parse(atob(token.split(".")[1]));
              username = payload.username || "User";
              localStorage.setItem("username", username);
            } catch (e) {
              username = "User";
            }
          }

          // Set username in navigation
          document.getElementById(
            "nav-username"
          ).textContent = `Hello, ${username}`;

          document.getElementById("main-nav").style.display = "block";
          const lastSection = localStorage.getItem("lastSection") || "networth";
          showSection(lastSection);
        } else {
          document.getElementById("main-nav").style.display = "none";
          showSection("auth");
        }
      };

      document.getElementById("login-form").onsubmit = async function (e) {
        e.preventDefault();
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        try {
          const res = await fetch("http://3.229.166.20:4000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok && data.token) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("username", username);
            localStorage.setItem("loginTime", Date.now().toString());

            // Set username in navigation
            document.getElementById(
              "nav-username"
            ).textContent = `Hello, ${username}`;

            // Show navigation and switch to networth
            document.getElementById("main-nav").style.display = "block";
            showSection("networth");

            // Fetch new user's dashboard data
            if (typeof fetchNetWorth === "function") fetchNetWorth();
            if (typeof fetchUsername === "function") fetchUsername();

            // Reinitialize theme after login
            initializeTheme();

            document.getElementById("auth-message").textContent = "";
          } else {
            document.getElementById("auth-message").textContent =
              data.error || data.message || "Login failed";
          }
        } catch (err) {
          document.getElementById("auth-message").textContent = "Network error";
        }
      };

      document.getElementById("register-form").onsubmit = async function (e) {
        e.preventDefault();
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;
        try {
          const res = await fetch(
            "http://3.229.166.20:4000/api/auth/register",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username, password }),
            }
          );
          const data = await res.json();
          if (res.ok && data.message) {
            document.getElementById("auth-message").textContent =
              "Registration successful! Please log in.";
          } else {
            document.getElementById("auth-message").textContent =
              data.error || data.message || "Registration failed";
          }
        } catch (err) {
          document.getElementById("auth-message").textContent = "Network error";
        }
      };

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("loginTime");
        document.getElementById("main-nav").style.display = "none";
        document.getElementById("nav-username").textContent = "";
        showSection("auth");
        document.getElementById("auth-message").textContent = "";
      }

      // Theme toggle functionality
      // Switch between login and register tabs
      function switchAuthTab(tab) {
        const loginTab = document.getElementById("login-tab");
        const registerTab = document.getElementById("register-tab");
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        if (tab === "login") {
          loginTab.classList.add("active");
          registerTab.classList.remove("active");
          loginForm.style.display = "block";
          registerForm.style.display = "none";
        } else {
          loginTab.classList.remove("active");
          registerTab.classList.add("active");
          loginForm.style.display = "none";
          registerForm.style.display = "block";
        }
      }
      function toggleTheme() {
        console.log("Theme toggle clicked!"); // Debug log
        const body = document.body;
        const themeToggle = document.getElementById("theme-toggle");

        if (body.classList.contains("dark-theme")) {
          body.classList.remove("dark-theme");
          themeToggle.textContent = "üåô";
          localStorage.setItem("theme", "light");
          console.log("Switched to light theme");
        } else {
          body.classList.add("dark-theme");
          themeToggle.textContent = "‚òÄÔ∏è";
          localStorage.setItem("theme", "dark");
          console.log("Switched to dark theme");
        }
      }

      // Initialize theme on page load
      function initializeTheme() {
        const savedTheme = localStorage.getItem("theme");
        const themeToggle = document.getElementById("theme-toggle");
        console.log("Initializing theme:", savedTheme); // Debug log

        if (savedTheme === "dark") {
          document.body.classList.add("dark-theme");
          if (themeToggle) themeToggle.textContent = "‚òÄÔ∏è";
        } else {
          document.body.classList.remove("dark-theme");
          if (themeToggle) themeToggle.textContent = "üåô";
        }
      }
    </script>
  </body>
</html>
